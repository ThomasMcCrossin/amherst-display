# Amherst Display Codebase Architecture Analysis

## Project Overview
**Project Name:** amherst-display  
**Type:** Sports event display board system for Amherst Ramblers and Ducks hockey teams  
**Stack:** Node.js backend (data scraping/processing) + Single-page HTML5 frontend  
**Main Purpose:** Real-time game schedule and standings display for stadium/venue screens

---

## 1. OVERALL PROJECT STRUCTURE

```
amherst-display/
├── .github/workflows/        # GitHub Actions CI/CD
│   └── build-jsons.yml       # Daily schedule: 06:30 UTC (3:30am Atlantic)
├── .git/                     # Git repository
├── assets/                   # Static media assets
│   ├── logos/                # Team logos (PNG)
│   │   ├── mhl/              # Maritime Hockey League team logos
│   │   ├── bshl/             # Beausejour Senior Hockey League logos
│   │   └── ccmha/            # Minor hockey (Cumberland Ramblers)
│   ├── standings/            # Screenshot storage for standings snapshots
│   ├── bg/                   # Background images (ice-texture.jpg)
│   └── league/               # League badges (mhl.png, bshl.png)
├── data/                     # Input data
│   └── ramblers.ics          # Amherst Ramblers schedule (iCalendar format)
├── scripts/                  # Node.js data processing scripts
│   ├── build_all.mjs         # Main orchestrator script
│   ├── schedules.mjs         # Parse ICS + fetch BSHL schedules
│   ├── standings.mjs         # Scrape & parse standings tables
│   ├── snap_standings.mjs    # Generate standings PNG screenshots
│   └── ccmha.mjs             # Fetch minor hockey games
├── index.html                # Single-page web application (SPA)
├── teams.json                # Team metadata registry
├── overrides.json            # Dynamic display messages/tickers
├── games.json                # Generated: all upcoming games
├── next_games.json           # Generated: next 3 games per team
├── standings_mhl.json        # Generated: MHL standings data
├── standings_bshl.json       # Generated: BSHL standings data
├── ccmha_games.json          # Generated: minor hockey games
├── ramblers.ics              # Generated/synced: calendar export
├── package.json              # Node.js dependencies
└── build.log                 # Last build output log
```

---

## 2. DATA ORGANIZATION & JSON STRUCTURES

### 2.1 Core Data Files

#### **teams.json** (Team Registry)
**Purpose:** Central team directory with metadata and branding  
**Location:** `/home/user/amherst-display/teams.json`

**Structure:**
```json
{
  "league_meta": {
    "MHL": {
      "badge": "assets/league/mhl.png",
      "color": "#2d74ff"
    },
    "BSHL": {
      "badge": "assets/league/bshl.png", 
      "color": "#19c37d"
    }
  },
  "teams": [
    {
      "slug": "amherst-ramblers",
      "league": "MHL",
      "name": "Amherst Ramblers",
      "aliases": ["Ramblers", "Amherst"],
      "logo_url": "https://thomasmccrossin.github.io/amherst-display/assets/logos/mhl/amherst-ramblers.png"
    },
    // ... 17 teams total (12 MHL, 8 BSHL)
  ]
}
```

**Key Design Patterns:**
- **slug:** Standardized lowercase identifier (used as unique key)
- **aliases:** Multiple name variations for schedule parsing
- **logo_url:** GitHub Pages absolute URLs (self-hosted images)
- Teams are manually maintained here; aliases map to slugs for schedule parsing

#### **games.json** (Master Schedule)
**Purpose:** All upcoming games for Ramblers and Ducks  
**Location:** `/home/user/amherst-display/games.json`  
**Generated by:** `scripts/schedules.mjs` → called by `scripts/build_all.mjs`

**Structure:**
```json
{
  "generated_at": "2025-11-09T04:16:06Z",
  "timezone": "America/Halifax",
  "events": [
    {
      "league": "MHL",
      "home_team": "Grand Falls Rapids",
      "away_team": "Amherst Ramblers",
      "home_slug": "grand-falls-rapids",
      "away_slug": "amherst-ramblers",
      "start": "2025-09-12T19:00:00-03:00",
      "end": "2025-09-12T22:00:00-03:00",
      "location": "E. & P. Sénéchal Centre"
    },
    // ... all scheduled games
  ]
}
```

**Data Flow:**
1. **Source 1 - Amherst Ramblers:** `data/ramblers.ics` (iCalendar format)
2. **Source 2 - Amherst Ducks:** Web scraping from BSHL standings page
3. **Processing:** Parse event titles → match team names → lookup slugs using aliases
4. **Normalization:** Ensure valid ISO timestamps, timezone-aware times
5. **Deduplication:** Remove duplicate events by league|home|away|start combination

**Event Properties:**
- `league`: "MHL" or "BSHL"
- `start/end`: ISO 8601 with Atlantic timezone offset
- `location`: Venue name (used to filter "home games only")
- `home_slug/away_slug`: Keys into teams.json for logo lookup

#### **next_games.json** (Team-specific Upcoming Games)
**Purpose:** Quick reference for next 3 games per team  
**Location:** `/home/user/amherst-display/next_games.json`

**Structure:**
```json
{
  "generated_at": "2025-11-09T04:16:06Z",
  "timezone": "America/Halifax",
  "teams": [
    {
      "team_slug": "amherst-ramblers",
      "games": [
        {
          "opponent_slug": "grand-falls-rapids",
          "home": false,
          "start": "2025-09-12T19:00:00-03:00",
          "venue": "E. & P. Sénéchal Centre",
          "city": ""
        },
        // ... 2 more games
      ]
    },
    {
      "team_slug": "amherst-ducks",
      "games": [
        // ... next 3 Ducks games
      ]
    }
  ]
}
```

#### **standings_mhl.json & standings_bshl.json**
**Purpose:** Current league standings with team stats  
**Location:** Generated by `scripts/standings.mjs`

**Structure (per league):**
```json
{
  "generated_at": "2025-11-09T04:16:05.621Z",
  "season": "",
  "league": "MHL",
  "rows": [
    {
      "col": "1",
      "team": "Summerside Western Capitals",
      "slug": "summerside-western-capitals",
      "gp": 17,
      "w": 10,
      "l": 3,
      "otl": 3,
      "sol": 1,
      "pts": 24,
      "pct": "0.706",
      "rw": 8,
      "otw": 2,
      "sow": 0,
      "gf": 75,
      "ga": 62,
      "diff": 13,
      "pim": "482",
      "streak": "0-2-0-0",
      "p10": "5-3-2-0"
    },
    // ... all teams in league
  ]
}
```

**Stats Fields:**
- `gp/w/l/otl/sol`: Games Played, Wins, Losses, OT Losses, Shootout Losses
- `pts`: Points in standings
- `pct`: Win percentage
- `rw/otw/sow`: Regular Wins, OT Wins, Shootout Wins
- `gf/ga`: Goals For/Against, `diff`: Goal differential
- `pim`: Penalty minutes
- `streak`: Current streak record
- `p10`: Record in last 10 games

#### **ccmha_games.json** (Minor Hockey)
**Purpose:** Cumberland Ramblers junior hockey schedule  
**Source:** GrayJay Leagues API

**Structure:**
```json
{
  "generated_at": "2025-11-09T04:16:06Z",
  "timezone": "America/Halifax",
  "games": [
    {
      "start": "2025-11-15T14:00:00-04:00",
      "home_team": "Cumberland Ramblers U16",
      "away_team": "Team A",
      "league": "MHL U16"
    },
    // ... junior hockey games
  ]
}
```

### 2.2 Metadata Files

#### **overrides.json** (Dynamic Messaging)
**Purpose:** Promotional messages, tickers, welcome screens  
**Location:** `/home/user/amherst-display/overrides.json`

**Structure:**
```json
{
  "active": false,
  "type": "full",
  "until": "2025-10-12T18:00:00-03:00",
  "text": "Welcome U11 Tournament Teams!",
  "subtext": "Good luck this weekend • Concessions open late",
  "image_url": "assets/overrides/welcome-u11.png",
  "ticker": "CANTEEN SPECIAL: Poutine + Pop Combo • Amherst Candy Shoppe across from ScotiaBank • Curly's Sports & Supplements: Buy 10 Get 2 Free"
}
```

**Features:**
- `active`: Toggle whether override is displayed
- `type`: "full" (full-screen) or other layouts
- `until`: Expiration timestamp
- `ticker`: Scrolling marquee text

### 2.3 Input Data Files

#### **data/ramblers.ics** (iCalendar Format)
**Purpose:** Amherst Ramblers schedule  
**Format:** RFC 5545 iCalendar format  
**Source:** HockeyTech LeagueStat system (likely imported manually)

**Structure:**
```
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Hockeytech//Leaguestat iCal//EN
BEGIN:VEVENT
UID:489868d2d642ca8b84612@hockeytech.com
DTSTART:20250912T220000Z
DTEND:20250913T010000Z
LOCATION:E. & P. Sénéchal Centre
SUMMARY:Amherst Ramblers @ Grand Falls Rapids
STATUS:CONFIRMED
END:VEVENT
// ... more events
END:VCALENDAR
```

**Parsing Logic:**
- Extract VEVENT blocks (minimal parser in schedules.mjs)
- Parse DTSTART/DTEND as UTC
- Convert to Atlantic timezone (DST-aware)
- Extract location and team names from SUMMARY field

---

## 3. TEAM/PLAYER INFORMATION STORAGE

### Current State: NO PLAYER/ROSTER DATA
**IMPORTANT:** The codebase currently does NOT include:
- Player names
- Player numbers
- Player positions
- Player statistics
- Player photos/headshots
- Team rosters

### How Team Information is Currently Stored:
1. **teams.json:** Basic team metadata (name, slug, logo, league)
2. **standings_*.json:** Team-level statistics only (no player data)
3. **games.json:** Game schedule with team names/slugs (no player data)

### Absence of Player Data:
- No `rosters.json` file
- No individual player JSON files
- No player images or headshots directory
- No player statistics tracking
- Frontend JavaScript (index.html) only displays:
  - Game schedule
  - Standings
  - Team logos
  - Countdowns

---

## 4. IMAGE & ASSET STORAGE

### Logo Directory Structure
**Location:** `/home/user/amherst-display/assets/logos/`

#### MHL Team Logos
```
assets/logos/mhl/
├── amherst-ramblers.png              (100 KB)
├── chaleur-lightning.png              (110 KB)
├── grand-falls-rapids.png           (1.4 MB)
├── edmundston-blizzard.png          (740 KB)
├── pictou-county-weeks-crushers.png (520 KB)
├── summerside-western-capitals.png  (780 KB)
├── truro-bearcats.png                (3.5 KB)
├── valley-wildcats.png               (450 KB)
├── west-kent-steamers.png            (230 KB)
├── yarmouth-mariners.png             (370 KB)
├── miramichi-timberwolves.png        (250 KB)
├── campbellton-tigers.png            (680 KB)
└── (12 files total)
```

#### BSHL Team Logos
```
assets/logos/bshl/
├── amherst-ducks.png
├── belle-baie.png
├── bouctouche.png
├── dalhousie.png
├── elsipogtog.png
├── fredericton.png
├── miramichi.png
├── peninsule.png
└── (8 files total)
```

#### Minor Hockey Logos
```
assets/logos/ccmha/
└── cumberland-ramblers.png           (Minor hockey logo)
```

#### League Badges
```
assets/league/
├── mhl.png                            (League badge for MHL)
└── bshl.png                           (League badge for BSHL)
```

#### Standings Snapshots
```
assets/standings/
└── .gitkeep                           (Directory for standings PNG screenshots)
```

**No player/headshot storage currently exists.**

---

## 5. DATA PROCESSING PIPELINE

### Scripts Organization

#### **scripts/build_all.mjs** (Main Orchestrator)
**Purpose:** Coordinate all data generation  
**Execution:** GitHub Actions daily at 06:30 UTC (3:30am Atlantic)

**Workflow:**
1. Load teams.json → create name-to-slug mapping (case-insensitive)
2. Call `buildStandings()` → generates `standings_mhl.json` + `standings_bshl.json`
3. Call `buildSchedules()` → generates `games.json` + `next_games.json`
4. Call `buildCCMHA()` → generates `ccmha_games.json`
5. Write fallback files if any stage fails
6. Log summary statistics

**Key Functions:**
- `loadTeamDirectory()`: Reads teams.json, creates alias-to-slug map
- `sanitizeEvents()`: Validates events, removes duplicates, sorts by start time
- `nextN()`: Extracts next N future games for a team

#### **scripts/schedules.mjs** (Schedule Processing)
**Purpose:** Parse game schedules from multiple sources

**Functions:**
- `fetchRamblersICSRaw()`: Read local `data/ramblers.ics` or fetch from env var `RAMBLERS_ICS_URL`
- `parseICS()`: Minimal RFC 5545 parser
- `fetchRamblersFromICS()`: Extract Ramblers games with slug mapping
- `fetchDucksFromBSHL()`: Web scrape BSHL website for Ducks games

**Features:**
- Atlantic timezone handling (DST-aware calculations)
- Team name matching with fuzzy lookup via aliases
- Timezone conversion from UTC iCalendar format

#### **scripts/standings.mjs** (Standings Scraping)
**Purpose:** Fetch current standings from league websites

**Targets:**
- **MHL:** `https://www.themhl.ca/stats/standings`
  - Uses Puppeteer (headless Chrome) for JavaScript rendering
  - Parses dynamically-rendered HTML tables
  
- **BSHL:** `https://www.beausejourseniorhockeyleague.ca/standings.php`
  - Parses static HTML tables with regex fallback

**Functions:**
- `fetchText()`: HTTP fetch with error handling
- `parseBSHLTable()`: Extract table rows and headers
- `parseTableRows()`: Generic table parsing with flexible column matching
- `attachSlug()`: Map team names to slugs using directory

#### **scripts/snap_standings.mjs** (Screenshot Generation)
**Purpose:** Generate PNG screenshots of standings for display boards

**Process:**
1. Load standings JSON
2. Render HTML view
3. Use Puppeteer to screenshot
4. Save to `assets/standings/`

#### **scripts/ccmha.mjs** (Minor Hockey)
**Purpose:** Fetch Cumberland Ramblers junior hockey schedule

**Source:** GrayJay Leagues API

---

## 6. FRONTEND APPLICATION (index.html)

### Architecture: Single-Page Application (SPA)

**Technology:**
- Vanilla JavaScript (no frameworks)
- CSS Grid + Flexbox layout
- Embedded styles (no separate CSS file)
- Responsive design (1820px max-width)

### Key Components

#### Data Loading
- Fetches JSON files from GitHub Pages
- Implements localStorage fallback (caches last successful `games.json`)
- Auto-refresh every 10 minutes
- Cache-busting with timestamp query parameter

#### Display Modes

**1. Normal Schedule View (Weekly)**
- Grid layout: Hero (1 game) → Split (2) → List (3+)
- Shows next 7 days of home games
- Team logos + game time + location
- League badge (MHL/BSHL)

**2. Countdown Mode**
- Triggered 24 hours before Amherst home game
- Large display: Days • Hours • Minutes • Seconds
- Real-time tick-down (updates every second)
- Special "Pre-Game" message (60 min before puck drop)

**3. CCMHA Minor Hockey Section**
- Separate section for junior hockey games
- Simpler card layout
- Optional based on available games

**4. Pagination**
- Auto-rotate pages every 20 seconds
- Visual indicator dots
- Supports multiple games per page

### Configuration Variables
```javascript
const CONFIG = {
  DATA_URL: "https://thomasmccrossin.github.io/amherst-display/games.json",
  TEAMS_URL: "https://thomasmccrossin.github.io/amherst-display/teams.json",
  OVERRIDES_URL: "https://thomasmccrossin.github.io/amherst-display/overrides.json",
  CCMHA_URL: "https://thomasmccrossin.github.io/amherst-display/ccmha_games.json",
  DAYS_AHEAD: 7,
  HOME_ONLY: true,
  HOME_VENUES: ["Amherst Stadium"],
  TIMEZONE: "America/Halifax",
  REFRESH_MINUTES: 10,
  COUNTDOWN_HOURS: 24,
  PREGAME_MINUTES: 60,
  PAGINATION_ROTATION_SECONDS: 20,
  MAX_RAMBLERS_DUCKS_PER_PAGE: 3,
  MAX_CCMHA_PER_PAGE: 6,
  LEAGUE: {
    MHL: { tagClass: "mhl", icon: "assets/league/mhl.png" },
    BSHL: { tagClass: "bshl", icon: "assets/league/bshl.png" }
  }
};
```

### Color Scheme
- **MHL:** #2d74ff (blue)
- **BSHL:** #19c37d (green)
- **Accent:** #f28c18 (orange)
- **Background:** Dark gradient (#0b0c10 to #0f1219)

---

## 7. CI/CD & AUTOMATION

### GitHub Actions Workflow (build-jsons.yml)

**Schedule:**
- Daily trigger: 06:30 UTC (3:30am Atlantic)
- Manual trigger: workflow_dispatch
- Push trigger: Changes to scripts/, teams.json, data/, package.json

**Steps:**
1. Checkout repository
2. Setup Node.js v20 with npm cache
3. Cache Puppeteer/Chrome browsers
4. Install Chrome (required for headless rendering)
5. Run `node scripts/build_all.mjs` → generates all JSON files
6. Run `npm run snap` → generate standings screenshots
7. Upload build.log as artifact
8. Git commit & push changes (if any)

**GitHub Pages Deployment:**
- Uses `thomasmccrossin.github.io` subdomain
- All JSON and asset URLs point to GitHub Pages

---

## 8. CURRENT DATA FLOW DIAGRAM

```
┌─────────────────────────────────────────────────────────────────┐
│                      DATA SOURCES                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  data/ramblers.ics ──┐                                          │
│  (HockeyTech ICS)    │      schedules.mjs ─→ games.json         │
│                      ├──→                      next_games.json    │
│  BSHL website ───────┘      (Parse + merge)                     │
│                                                                   │
│  https://themhl.ca/stats/standings ─┐                           │
│                                      ├──→ standings.mjs ─→ standings_mhl.json
│  https://beausejour...standings     ─┘     (Scrape + parse)     standings_bshl.json
│                                                                   │
│  GrayJay Leagues API ──→ ccmha.mjs ──→ ccmha_games.json         │
│                                                                   │
│  teams.json ──────────→ (Alias mapping & slug lookup)           │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  build_all.mjs ORCHESTRATES                      │
├─────────────────────────────────────────────────────────────────┤
│  - Validates all JSON outputs                                    │
│  - Writes fallback files if any stage fails                     │
│  - Logs statistics                                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│            Generated JSON files (in repo root)                   │
├─────────────────────────────────────────────────────────────────┤
│  - games.json                                                    │
│  - next_games.json                                               │
│  - standings_mhl.json                                            │
│  - standings_bshl.json                                           │
│  - ccmha_games.json                                              │
│  - build.log                                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          GitHub Actions: Commit & Push to GitHub Pages           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│    index.html (Frontend) fetches JSON from GitHub Pages URLs    │
├─────────────────────────────────────────────────────────────────┤
│  - Loads teams.json, games.json, overrides.json, ccmha_games.json
│  - Renders display board with logos, schedules, countdowns      │
│  - Updates every 10 minutes                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. KEY TECHNICAL DECISIONS

| Aspect | Choice | Rationale |
|--------|--------|-----------|
| **Web Stack** | Vanilla JS SPA | No external dependencies, simple deployment |
| **Data Format** | JSON | Universal, easy to parse/serialize |
| **Logos** | Self-hosted on GitHub | Reliable CDN via GitHub Pages |
| **Scheduling** | ICS file + web scraping | Flexible: manual ICS import + automated web parsing |
| **Standings** | Web scraping | League websites don't provide APIs |
| **Backend** | Node.js scripts | Lightweight, easy CI/CD integration |
| **Deployment** | GitHub Pages + Actions | No server costs, automatic updates |
| **Timezone** | Atlantic (America/Halifax) | All times local to venue |

---

## 10. EXTENSION POINTS FOR ROSTER DATA

### Recommended Structure for Player/Roster Data

**If adding player/roster features:**

1. **New file: `rosters.json`**
```json
{
  "generated_at": "2025-11-09T04:16:06Z",
  "rosters": [
    {
      "team_slug": "amherst-ramblers",
      "season": "2025-2026",
      "players": [
        {
          "number": 14,
          "name": "Player Name",
          "position": "F",
          "headshot_url": "assets/headshots/amherst-ramblers/14-player-name.jpg"
        },
        // ... more players
      ]
    },
    // ... other teams
  ]
}
```

2. **Image Storage: `assets/headshots/`**
```
assets/headshots/
├── amherst-ramblers/
│   ├── 14-player-name.jpg
│   ├── 23-another-player.jpg
│   └── ...
├── amherst-ducks/
│   └── ...
└── (one per team)
```

3. **Backend Script: `scripts/rosters.mjs`**
   - Fetch from HockeyTech API or manual CSV
   - Validate player numbers/names
   - Generate rosters.json

4. **Frontend Updates: `index.html`**
   - Load rosters.json alongside games.json
   - Add player cards/roster page view
   - Display headshots in team context

---

## 11. DEPENDENCIES & TECHNOLOGY

### Node.js Packages (scripts)
- **cheerio:** HTML/XML parsing (jQuery-like syntax)
- **puppeteer:** Headless Chrome for JavaScript rendering
- **date-fns & date-fns-tz:** Date manipulation and timezone handling
- **node-fetch:** HTTP client for Node.js

### Runtime Requirements
- Node.js >= v20 (LTS)
- Chrome/Chromium (installed by Puppeteer)
- npm for dependency management

### Frontend (No build step)
- Plain HTML5
- Vanilla JavaScript (no dependencies)
- CSS Grid + Flexbox
- Intl API (browser-native date/time formatting)

---

## SUMMARY

**Current Capabilities:**
✓ Multi-team game scheduling (Ramblers + Ducks + junior hockey)  
✓ Automatic standings scraping (MHL + BSHL)  
✓ Real-time countdown displays  
✓ Responsive display board interface  
✓ Auto-refresh + fallback data (localStorage)  
✓ GitHub Pages deployment with zero server cost  

**Missing Capabilities (for roster feature):**
✗ No player/roster data structures  
✗ No player statistics  
✗ No headshot/image storage  
✗ No player lookup/search  
✗ No roster management UI  

**Extensibility:**
- Clean separation between data (JSON) and presentation (HTML/JS)
- Modular script structure (easy to add new data sources)
- GitHub Actions workflow enables automated updates
- Asset storage pattern established (can extend for player images)
